# コンピュート・インスタンスのメトリック情報が確認できないトラブルを解決しよう

## 問題

OCI上に MuShop というペット用品のEコマースアプリケーションが稼働しています。このアプリケーションは複数の仮想マシン・インスタンスから構成されるアプリケーション層と、Autonomous Transaction Processing (ATP) で構成されるデータベース層からなり、そのほかに踏み台用の仮想マシンも構成されています。  
OCIにはモニタリング・サービスというCPU使用率やネットワークの利用状況などのメトリック(統計)情報を取得し、コンソールにグラフ表示するサービスがあります。現在この環境において、アプリケーション層を構成する仮想マシンについては、コンソール上のメトリック情報が表示できていません。この状況を改善し、アプリケーション層についてもOCIモニタリング・サービスを使ってメトリック情報を表示できるように構成してください。

 (所要時間：15分程度)

## ヒント

### ヒント1

まず、OCIコンソールでアプリケーションサーバーを構成するコンピュート・インスタンスを特定しましょう。仮想マシンは必ずしも1台であるとは限りません。その上で、そのコンピュート・インスタンスの状況を観察し、メトリックが取得できない状況を確認し、その理由を推定しましょう。  
もし問題の特定が難しいようであれば、どこか近くに正しくメトリックが取得できているインスタンスがあるはずです。そのインスタンスを探し出し、比較することで、うまく作業が進むかもしれません。

### ヒント2

問題を特定するにあたっては、まずモニタリング・サービスがどのような仕組みでメトリックを収集するかを正しく理解する必要があります。  
もしモニタリング・サービスについて詳しくない場合は、以下のドキュメントにアクセスして詳細を確認することをお勧めします。

[モニタリングの概要](https://docs.oracle.com/ja-jp/iaas/Content/Monitoring/Concepts/monitoringoverview.htm)

また、コンピュート・インスタンスからメトリックを取得する方法については、以下のドキュメントが参考になるはずです。

[コンピュート・メトリックおよびモニタリング](https://docs.oracle.com/ja-jp/iaas/Content/Compute/References/computemetricsoverview.htm)

### ヒント3

コンピュート・インスタンスからメトリックを取得するには、そのインスタンスにOracle Cloud Agentがインストールされ、さらにコンピュート・インスタンスのモニタリング・プラグインが稼働している必要があります。OCIのコンソールから稼働の状況を確認することができるので、現在の状況を確認してみましょう。

### ヒント4

コンピュート・インスタンスでエージェントが正しく稼働しているだけでは、メトリックがOCIモニタリング・サービスが正しくデータを取得することができるとは限りません。もし行き詰まった場合は、もう一度[コンピュート・メトリックおよびモニタリング](https://docs.oracle.com/ja-jp/iaas/Content/Compute/References/computemetricsoverview.htm)を参照し、どこに問題があるかを考えてみましょう。

### ヒント5

ドキュメントに [トラブルシューティング: モニタリングにメトリックが含まれるかどうかの確認](https://docs.oracle.com/ja-jp/iaas/Content/Compute/Tasks/enablingmonitoring.htm#FindOutIfEnabled
)) という項目があるのに気づきましたか? その中にインスタンスのメトリックが表示されない場合のトラブルシューティング・ガイドが掲載されています。これらの項目を確認し、問題を一つずつ解消していきましょう。


## 解答

このMuShopアプリケーションにおいては、メトリックを表示するのに複数の設定項目が足りていません。正しく表示するには以下の作業を実施する必要があります。

- Oracle Cloud Agentのコンピュート・インスタンスのモニタリング・プラグインを有効化する
    - このインスタンスでは、Oracle Cloud Agentは稼働していますが、その中のモニタリング情報を収集するためのプラグインが有効化されていません
    - プラグインはOCIコンソールから有効化することができます。作業は[ドキュメント - 既存のコンピュート・インスタンスのモニタリングの有効化](https://docs.oracle.com/ja-jp/iaas/Content/Compute/Tasks/enablingmonitoring.htm#ExistingEnabling)を参考に実施します
- コンピュート・インスタンスからOCIモニタリング・サービスへの適切な通信経路を確立する
    - コンピュート・インスタンスからOCIモニタリング・サービスにはサービス・ゲートウェイを経由してデータが送信されますが、この環境はサービス・ゲートウェイへの適切なルートが設定されていません
    - サービス・ゲートウェイは作成済みです
    - 以下の手順に従って、サービス・ゲートウェイへのルートを作成します
        - 「ネットワーキング → 仮想クラウド・ネットワーク」→ 対象の VCN「(チーム名)-mushop-vcn」を選択
        - 「ルーティング」タブを選択
        - 「(チーム名)-mushop-private-route-table」という名前のルート表を選択
        - 「ルート・ルール」タブを選択
        - 「ルート・ルールの追加」ボタンをクリックして、以下の値を設定  
| 設定項目 | 値 |
| :---- | :---- |
| ターゲット・タイプ | サービス・ゲートウェイ |
| ターゲット・サービス・ゲートウェイコンパートメント | (各チームのコンパートメント名) |
| ターゲット・サービス・ゲートウェイ | (チーム名)-mushop-service-gateway |

注意 : 全ての設定項目を完了した後、OCIコンソール上でメトリックのデータを確認できるようになるまでには、数分程度のタイムラグがある場合があります。

また、以下の項目については今回は作業は必要ありませんが、トラブルシューティングの過程で確認作業が必要になる場合があります。

-  Oracle Cloud AgentがOCIモニタリングにデータを送信できるように適切な権限を設定する
   -  コンピュート・インスタンスに対して動的グループを作成する(今回は作成済)
   -  動的グループに対してOCIモニタリング・サービスへの適切な権限を付与するポリシーを作成する(今回は作成済)

上記作業を完了すると、数分後にコンピュート・インスタンスの詳細画面から、CPU使用率、メモリ使用率などのメトリック情報を確認できるようになります。
