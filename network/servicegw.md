# OCI Monitoring でメトリクスが確認できない (所要時間：15分程度)

## 問題

MuShop アプリケーションが OCI 上の仮想マシン（VM）で稼働しています。この VM に対して OCI Monitoring を有効化しようとしていますが、以下の問題に直面しています。

- OCI コンソールの「モニタリング → メトリクス」から該当 VM を選択しても、カスタムメトリクスやシステムメトリクスが表示されない
- VM 側で oci-cli や curl を使っても、Monitoring API へのアクセスが失敗する（タイムアウトまたは名前解決できない）
- VM は Instance Principal（インスタンス・プリンシパル） を使っており、正しい IAM ポリシーも付与されている
- VM は プライベートサブネットに存在しており、インターネットには直接出られない構成

この VM で OCI Monitoring を利用できるようにしてください。
ネットワーク設定に起因する可能性があります。原因を特定して、適切な対応を行ってください。

## 解答

### 原因

- この VM が所属している サブネットのルートテーブルに、all-services（OCI Services）向けのルートが定義されていない
- そのため、Monitoring や Logging 等の Oracle 管理サービスにアクセスできない
- インスタンス・プリンシパルやエージェントは正しく設定されていても、ネットワーク経路がないため通信できない

### 解答手順

1. サービスゲートウェイの存在を確認

- 「ネットワーキング → 仮想クラウド・ネットワーク」→ 対象の VCN「questdev-mushop-vcn」を選択
- 「ルーティング」タブを選択
- 「questdev-mushop-private-route-table」という名前のルート表を選択
- 「ルート・ルール」タブを選択
- 「ルート・ルールの追加」ボタンをクリックして、以下の値を設定

| 設定項目 | 値 |
| :---- | :---- |
| ターゲット・タイプ | サービス・ゲートウェイ |
| ターゲット・サービス・ゲートウェイコンパートメント | ociquest-dev（実際は各チームのコンパートメント名） |
| ターゲット・サービス・ゲートウェイ | questdev-mushop-service-gateway |

2. 確認

数分後、OCI Monitoring のメトリクス画面で VM の CPU、メモリ、ディスクなどの情報が表示されることを確認する。


